{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "webAppName": {
      "type": "string",
      "defaultValue": "whatsapp-health-assistant",
      "metadata": {
        "description": "Web app name."
      },
      "minLength": 2
    },
    "location": {
      "type": "string",
      "defaultValue": "[resourceGroup().location]",
      "metadata": {
        "description": "Location for all resources."
      }
    },
    "sku": {
      "type": "string",
      "defaultValue": "F1",
      "metadata": {
        "description": "The SKU of App Service Plan."
      }
    },
    "repoUrl": {
      "type": "string",
      "defaultValue": "https://github.com/YOUR_USERNAME/whatsapp-health-assistant",
      "metadata": {
        "description": "The URL for the GitHub repository."
      }
    },
    "branch": {
      "type": "string",
      "defaultValue": "main",
      "metadata": {
        "description": "The branch of the GitHub repository to use."
      }
    },
    "supabaseUrl": {
      "type": "string",
      "metadata": {
        "description": "Supabase project URL"
      }
    },
    "supabaseKey": {
      "type": "securestring",
      "metadata": {
        "description": "Supabase anon key"
      }
    },
    "twilioAccountSid": {
      "type": "string",
      "metadata": {
        "description": "Twilio Account SID"
      }
    },
    "twilioAuthToken": {
      "type": "securestring",
      "metadata": {
        "description": "Twilio Auth Token"
      }
    },
    "twilioPhoneNumber": {
      "type": "string",
      "metadata": {
        "description": "Twilio WhatsApp phone number"
      }
    },
    "geminiApiKey": {
      "type": "securestring",
      "metadata": {
        "description": "Google Gemini API key"
      }
    }
  },
  "variables": {
    "appServicePlanName": "[concat('AppServicePlan-', parameters('webAppName'))]",
    "webAppPortalName": "[concat(parameters('webAppName'), '-webapp')]"
  },
  "resources": [
    {
      "type": "Microsoft.Web/serverfarms",
      "apiVersion": "2022-09-01",
      "name": "[variables('appServicePlanName')]",
      "location": "[parameters('location')]",
      "sku": {
        "name": "[parameters('sku')]"
      },
      "kind": "linux",
      "properties": {
        "reserved": true
      }
    },
    {
      "type": "Microsoft.Web/sites",
      "apiVersion": "2022-09-01",
      "name": "[variables('webAppPortalName')]",
      "location": "[parameters('location')]",
      "kind": "app,linux",
      "dependsOn": [
        "[resourceId('Microsoft.Web/serverfarms', variables('appServicePlanName'))]"
      ],
      "properties": {
        "serverFarmId": "[resourceId('Microsoft.Web/serverfarms', variables('appServicePlanName'))]",
        "siteConfig": {
          "linuxFxVersion": "NODE|18-lts",
          "appSettings": [
            {
              "name": "NODE_ENV",
              "value": "production"
            },
            {
              "name": "PORT",
              "value": "8000"
            },
            {
              "name": "SUPABASE_URL",
              "value": "[parameters('supabaseUrl')]"
            },
            {
              "name": "SUPABASE_KEY",
              "value": "[parameters('supabaseKey')]"
            },
            {
              "name": "TWILIO_ACCOUNT_SID",
              "value": "[parameters('twilioAccountSid')]"
            },
            {
              "name": "TWILIO_AUTH_TOKEN",
              "value": "[parameters('twilioAuthToken')]"
            },
            {
              "name": "TWILIO_PHONE_NUMBER",
              "value": "[parameters('twilioPhoneNumber')]"
            },
            {
              "name": "GEMINI_API_KEY",
              "value": "[parameters('geminiApiKey')]"
            },
            {
              "name": "RATE_LIMIT_WINDOW_MS",
              "value": "900000"
            },
            {
              "name": "RATE_LIMIT_MAX_REQUESTS",
              "value": "100"
            },
            {
              "name": "LOG_LEVEL",
              "value": "info"
            }
          ]
        }
      },
      "resources": [
        {
          "type": "sourcecontrols",
          "apiVersion": "2022-09-01",
          "name": "web",
          "dependsOn": [
            "[resourceId('Microsoft.Web/sites', variables('webAppPortalName'))]"
          ],
          "properties": {
            "repoUrl": "[parameters('repoUrl')]",
            "branch": "[parameters('branch')]",
            "isManualIntegration": true
          }
        }
      ]
    }
  ],
  "outputs": {
    "webAppUrl": {
      "type": "string",
      "value": "[concat('https://', variables('webAppPortalName'), '.azurewebsites.net')]"
    },
    "webhookUrl": {
      "type": "string",
      "value": "[concat('https://', variables('webAppPortalName'), '.azurewebsites.net/webhook')]"
    }
}
}